stages:
- compile
- test
- build

compile:extension:
  stage: compile
  image: node:10
  script:
  - cd extension
  - npm install
  - npm run-script build

test:daemon:
  stage: test
  image: golang:1.11
  script:
  - cd daemon
  - go test -cover -v ./...

test:extension:
  stage: test
  image: node:10
  script:
  - cd extension
  - npm install
  - npm run-script test

build:daemon:linux:
  stage: build
  image: golang:1.11
  script:
  - cd daemon
  - GOOS=linux GOARCH=amd64 go build -v ./...
  artifacts:
    paths:
    - /builds/phil9909/gitlab-local-connector/daemon/gitlab-local-connector

#build:daemon:mac:
#  stage: build
#  image: golang:1.11
#  script:
#  - cd daemon
#  - GOOS=darwin GOARCH=amd64 go build -v ./...
#  artifacts:
#    paths:
#    - /builds/phil9909/gitlab-local-connector/daemon/gitlab-local-connector

build:daemon:windows:
  stage: build
  image: golang:1.11
  script:
  - cd daemon
  - GOOS=windows GOARCH=amd64 go build -v ./...
  artifacts:
    paths:
    - /builds/phil9909/gitlab-local-connector/daemon/gitlab-local-connector.exe

build:extension:
  stage: build
  image: node:10
  script:
  - cd extension
  - 'sed -ri "s=\"version\": \"([^\"]*)=\"version\": \"\\1.$(date +%y%m%d.%H%M)=" manifest.json' # set the version number from x.x.x to x.x.x.date.time
  - npm install
  - npm run-script build
  - npm run-script pack
  artifacts:
    paths:
    - extension/extension.zip
